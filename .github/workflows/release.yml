name: CI

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      - run: pip install setuptools wheel setuptools-scm
      - run: |
          python - <<EOF
from setuptools_scm import get_version
print(get_version())
EOF

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-pre')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      - run: pip install setuptools-scm
      - run: |
          git config user.name "ci-bot"
          git config user.email "ci@bot"
          python scripts/write_version.py
          git commit -am "release ${GITHUB_REF_NAME}"
          git push
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - run: |
          ver=${{ github.ref_name#v }}
          IFS='.' read m n p <<< "$ver"
          next=v${m}.${n}.$((p+1))-pre1
          git tag $next
          python scripts/write_version.py
          git commit -am "start $next"
          git push --tags

  deliver:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      - run: pip install setuptools-scm
      - id: vars
        run: |
          echo "CURRENT=$(python - <<EOF
from setuptools_scm import get_version
print(get_version())
EOF
)" >> $GITHUB_OUTPUT
      - run: |
          base=${{ steps.vars.outputs.CURRENT%-pre* }}
          num=${{ steps.vars.outputs.CURRENT##*-pre }}
          next=${base}-pre$((num+1))
          git config user.name "ci-bot"
          git config user.email "ci@bot"
          git tag $next
          python scripts/write_version.py
          git commit -am "bump $next"
          git push --tags
