name: Release

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - run: |
          pip install setuptools wheel
          python setup.py sdist bdist_wheel

  bump:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - id: get_ver
        run: |
          echo "::set-output name=ver::$(grep -oP '(?<=__version__\s*=\s*")[^"]+' lib_version/version.py)"
      - run: |
          git checkout -B version-bump origin/main
          BASE=$(echo "${{ steps.get_ver.outputs.ver }}" | cut -d'-' -f1)
          IFS='.' read M N P <<<"$BASE"
          NEXT="$M.$N.$((P+1))-pre"
          sed -E "s/__version__ = \".*\"/__version__ = \"$NEXT\"/" lib_version/version.py > tmp && mv tmp lib_version/version.py
          git add lib_version/version.py
          git commit -m "chore: bump to $NEXT [skip ci]"
          git push origin version-bump:main
